name: Xmake Build

env:
  TARGET_NAME: mo_yanxi.utility
  LLVM_VER: 21

on:
  push:
    branches: [ "master" ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
  pull_request:
    branches: [ "master" ]
    paths-ignore:
      - '**.md'
      - 'docs/**'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    name: ${{ matrix.os }} - ${{ matrix.toolchain }} - ${{ matrix.mode }}
    runs-on: ${{ matrix.os }}

    # 2. 快速失败：任何一个 Job 挂了，立刻结束其他的，省钱
    strategy:
      fail-fast: true
      matrix:
        include:
          # 显式定义需要的组合，比 exclude 更清晰且不易出错
          - os: windows-latest
            toolchain: msvc
            mode: release
            plat: windows

          # 仅在 Windows 下测试 Clang (可选，为了省钱可以去掉这个，只测 MSVC)
          - os: windows-latest
            toolchain: clang
            mode: release
            plat: windows

          # Linux Clang 构建
          - os: ubuntu-latest
            toolchain: clang
            mode: release
            plat: linux

          # 如果为了省钱，Debug 模式可以只跑一个平台，或者完全去掉（依赖本地测试）
          # - os: ubuntu-latest
          #   toolchain: clang
          #   mode: debug
          #   plat: linux

    steps:
      - uses: actions/checkout@v4

      # 1. 设置 xmake 环境 (使用最新版)
      - name: Setup xmake
        uses: xmake-io/github-action-setup-xmake@v1
        with:
          xmake-version: latest
          actions-cache-folder: '.xmake-cache' # 配合 actions/cache 使用

      - name: Install LLVM
        if: matrix.os == 'ubuntu-latest' && matrix.toolchain == 'clang'
        run: |
          wget https://apt.llvm.org/llvm.sh
          chmod +x llvm.sh
          sudo ./llvm.sh ${{ env.LLVM_VER }} all
          # 安装 libc++ 依赖
          sudo apt-get install -y libc++-${{ env.LLVM_VER }}-dev libc++abi-${{ env.LLVM_VER }}-dev libunwind-${{ env.LLVM_VER }}-dev

      - name: Configure
        shell: bash
        run: |
          # 构造配置参数
          CONFIG_CMD="xmake f -m ${{ matrix.mode }} --toolchain=${{ matrix.toolchain }} -p ${{ matrix.plat }} -y --add_test=y"
          
          # Linux Clang 特殊处理
          if [[ "${{ matrix.os }}" == "ubuntu-latest" && "${{ matrix.toolchain }}" == "clang" ]]; then
             # 动态获取安装路径，避免硬编码版本号带来的路径错误
             LLVM_PATH="/usr/lib/llvm-${{ env.LLVM_VER }}"
             EXTRA_FLAGS="--sdk=$LLVM_PATH --cxflags=-stdlib=libc++ --ldflags='-stdlib=libc++ -lc++abi -lunwind'"
          
             # 只有当安装了自定义 LLVM 时才导出 PATH
             echo "$LLVM_PATH/bin" >> $GITHUB_PATH
          
             CONFIG_CMD="$CONFIG_CMD $EXTRA_FLAGS"
          fi

          echo "Running: $CONFIG_CMD"
          eval $CONFIG_CMD

      - name: Build
        run: xmake -bvy ${{ env.TARGET_NAME }}

      - name: Test
        run: xmake run ${{ env.TARGET_NAME }}.test