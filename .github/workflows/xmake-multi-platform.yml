name: Xmake Build

env:
  TARGET_NAME: mo_yanxi.vulkan_wrapper
  LLVM_VER: 21
  VULKAN_VER: 1.4.304.1

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  build:
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        os: [
          windows-latest,
          ubuntu-latest
        ]
        toolchain: [ msvc, clang, gcc ]
        mode: [ debug, release ]
        include:
          - os: windows-latest
            toolchain: msvc
          - os: windows-latest
            toolchain: clang
          # Linux 配置
          - os: ubuntu-latest
            toolchain: gcc
          - os: ubuntu-latest
            toolchain: clang
        exclude:
          # Windows 通常不用 gcc (MinGW)，除非特意配置，这里保持你原有的排除
          - os: windows-latest
            toolchain: gcc
          - os: ubuntu-latest
            toolchain: msvc

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Vulkan
        uses: humbletim/setup-vulkan-sdk@v1.2.1
        with:
          vulkan-query-version: ${{ env.VULKAN_VER }}
          vulkan-components: Vulkan-Headers, Vulkan-Loader
          vulkan-use-cache: true

      - name: Setup xmake
        uses: xmake-io/github-action-setup-xmake@v1
        with:
          xmake-version: latest

      # Modified: 使用统一的 Action 在 Windows 和 Linux 上安装 LLVM
      - name: Install LLVM
        if: matrix.toolchain == 'clang'
        uses: KyleMayes/install-llvm-action@v2
        with:
          version: "${{ env.LLVM_VER }}"
          # Windows 上不需要缓存 libc++，Linux 上可能需要
          cached: ${{ matrix.os == 'ubuntu-latest' }}

      - name: Build ${{ matrix.mode }}
        shell: bash
        run: |
          XMAKE_FLAGS="-m ${{ matrix.mode }} --toolchain=${{ matrix.toolchain }}"
          EXTRA_FLAGS=""
          PLAT_FLAGS=""
          
          if [ "${{ matrix.os }}" == "ubuntu-latest" ]; then
             PLAT_FLAGS="-p linux"
          else
             PLAT_FLAGS="-p windows"
          fi
          
          # 检查 Clang 版本 (Debug用)
          if [ "${{ matrix.toolchain }}" == "clang" ]; then
            clang --version
          fi
          
          # 针对 Linux Clang 的特殊配置 (libc++)
          # Windows 上 Clang 通常使用 MSVC 的 STL，或者你需要手动配置 libc++ 但比较麻烦
          # 这里保留你原有的 Linux 逻辑，Windows 下 EXTRA_FLAGS 为空即可自动使用 PATH 中的 clang
          if [[ "${{ matrix.os }}" == "ubuntu-latest" && "${{ matrix.toolchain }}" == "clang" ]]; then
             EXTRA_FLAGS="--sdk=/usr/lib/llvm-${{ env.LLVM_VER }} --cxflags='-stdlib=libc++' --ldflags='-stdlib=libc++'"
          else
             EXTRA_FLAGS=""
          fi
          
          echo "Configuring with: $XMAKE_FLAGS $EXTRA_FLAGS"
          xmake f -c $XMAKE_FLAGS $PLAT_FLAGS $EXTRA_FLAGS -y -cv
          
          xmake -b -y ${{ env.TARGET_NAME }}

      - name: Test
        run: xmake test